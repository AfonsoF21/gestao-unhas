<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o - Mariana Pereira</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #2C3E50; --accent: #D4AF37; --bg-color: #F8F9FA; --card-bg: #FFFFFF;
            --text-main: #333333; --text-light: #777777; --success: #27AE60; --danger: #E74C3C; --whatsapp: #25D366;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* TELA DE LOGIN SEGURA */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999;
        }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; width: 90%; max-width: 400px; }
        .login-box h2 { color: var(--primary); margin-bottom: 5px; }
        .login-box p { color: #666; margin-bottom: 25px; font-size: 14px; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; text-align: left; outline: none; transition: 0.3s;}
        .login-box input:focus { border-color: var(--accent); }
        .login-box button { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s;}
        
        /* TELA DE LOADING */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9);
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9998;
        }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* INTERFACE PRINCIPAL */
        #app-interface { display: none; width: 100%; height: 100%; }
        .sidebar { width: 250px; background-color: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0;}
        .logo { font-size: 24px; font-weight: bold; text-align: center; color: var(--accent); margin-bottom: 40px; }
        .menu-item { padding: 15px 25px; cursor: pointer; transition: 0.3s; font-size: 16px; border-left: 4px solid transparent; }
        .menu-item:hover, .menu-item.active { background-color: rgba(255,255,255,0.1); border-left: 4px solid var(--accent); color: var(--accent); }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; scroll-behavior: smooth; }
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 { margin-bottom: 25px; font-weight: 300; color: var(--primary); border-bottom: 2px solid var(--accent); padding-bottom: 10px; display: inline-block;}
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 4px solid var(--accent); text-align: center; }
        .card h3 { font-size: 14px; color: var(--text-light); margin-bottom: 10px; }
        .card .value { font-size: 32px; font-weight: bold; color: var(--primary); }
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 8px; margin-top: 15px; overflow: hidden; height: 10px; }
        .progress-bar { height: 100%; background-color: var(--primary); transition: width 0.5s; }

        .panel { background: var(--card-bg); padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 15px;}
        .form-row { display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; }
        label { font-size: 14px; color: var(--text-light); margin-bottom: 5px; font-weight: bold; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; outline:none;}
        
        button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.3s; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-accent { background-color: var(--accent); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-whatsapp { background-color: var(--whatsapp); color: white; }
        .btn-small { padding: 8px 12px; font-size: 12px; margin-right: 5px; margin-bottom: 5px;}
        
        .table-responsive { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; min-width: 600px; }
        th, td { padding: 15px; border-bottom: 1px solid #eee; text-align: left; }
        th { background-color: #fcfcfc; color: var(--text-light); text-transform: uppercase; font-size: 12px; }
        .mes-header { display: flex; justify-content: space-between; align-items: center; background: #eef2f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary); }
        .faturacao-total { font-size: 24px; font-weight: bold; color: var(--success); }

        /* MOBILE ADJUSTMENTS */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; flex-direction: row; padding: 0; position: fixed; bottom: 0; left: 0; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); overflow-x: auto; white-space: nowrap; }
            .logo { display: none; } 
            .menu-item { padding: 15px 10px; font-size: 14px; border-left: none; border-bottom: 4px solid transparent; flex: 1; text-align: center; }
            .menu-item:hover, .menu-item.active { border-bottom: 4px solid var(--accent); }
            .main-content { padding: 15px; padding-bottom: 80px; } 
            .dashboard-cards { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .form-row { flex-direction: column; align-items: stretch; }
            .mes-header { flex-direction: column; align-items: flex-start; gap: 15px; }
            button { width: 100%; }
            .btn-small { width: auto; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Mariana Pereira ‚ú®</h2>
            <p>Acesso com Email</p>
            <input type="email" id="input-email" placeholder="O teu Email">
            <input type="password" id="input-password" placeholder="A tua Palavra-passe">
            <button onclick="verificarLogin()">Entrar</button>
        </div>
    </div>

    <div id="loading-screen">
        <div class="spinner"></div>
        <h3 style="margin-top: 20px; color: var(--primary);">A ligar ao servidor...</h3>
    </div>

    <div id="app-interface">
        <div class="sidebar">
            <div class="logo">‚ú® MARIANA PEREIRA ‚ú®</div>
            <div class="menu-item active" onclick="mudarAba('dashboard', this)">üìä Dashboard</div>
            <div class="menu-item" onclick="mudarAba('agenda', this)">üìÖ Agenda</div>
            <div class="menu-item" onclick="mudarAba('clientes', this)">üë• Clientes</div>
            <div class="menu-item" onclick="mudarAba('faturacao', this)">üí∞ Fatura√ß√£o</div>
            <div class="menu-item" onclick="mudarAba('config', this)">‚öôÔ∏è Config</div>
        </div>

        <div class="main-content">
            <div id="dashboard" class="section active">
                <h1>Painel de Controlo</h1>
                <div class="dashboard-cards">
                    <div class="card"><h3>Total Clientes</h3><div class="value" id="dash-total-clientes">0</div></div>
                    <div class="card"><h3>Ocupa√ß√£o (M√™s)</h3><div class="value" id="dash-horas-ocupadas">0h</div></div>
                    <div class="card"><h3>Vagas</h3><div class="value" id="dash-vagas" style="color:var(--success);">0h</div></div>
                </div>
                <div class="panel">
                    <h3>Capacidade Mensal</h3>
                    <div class="progress-container"><div class="progress-bar" id="barra-ocupacao" style="width: 0%;"></div></div>
                    <p style="margin-top:10px; text-align:right;" id="texto-ocupacao">0%</p>
                </div>
            </div>

            <div id="agenda" class="section">
                <h1>Agenda Di√°ria</h1>
                <div class="panel">
                    <input type="date" id="input-data-agenda" onchange="renderAgenda()" style="margin-bottom: 20px;">
                    <div class="form-row">
                        <div class="form-group" style="flex:2;"><label>Cliente</label><select id="select-cliente-agenda"></select></div>
                        <div class="form-group" style="flex:1.5;"><label>Servi√ßo</label>
                            <select id="select-servico-agenda">
                                <option value="M√£os">M√£os</option>
                                <option value="P√©s">P√©s</option>
                                <option value="M√£os e P√©s">M√£os e P√©s</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex:1;"><label>Hora</label><input type="time" id="input-hora-agenda"></div>
                        <button class="btn-primary" onclick="addAgenda()">Agendar</button>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Hora</th><th>Cliente</th><th>Servi√ßo</th><th>Telem√≥vel</th><th>A√ß√µes</th></tr></thead>
                            <tbody id="tabela-agenda"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="clientes" class="section">
                <h1>Gest√£o de Clientes</h1>
                <div class="panel">
                    <div class="form-grid">
                        <div class="form-group"><label>Nome *</label><input type="text" id="nome"></div>
                        <div class="form-group"><label>Telem√≥vel</label><input type="text" id="telefone"></div>
                        <div class="form-group"> <label>Frequ√™ncia (Semanas)</label> <select id="frequencia"> <option value="3">3</option> <option value="4" selected>4</option> <option value="5">5</option> </select> </div>
                        <div class="form-group"> <label>Dura√ß√£o (Horas)</label> <select id="duracao"> <option value="1" selected>1h</option> <option value="1.5">1.5h</option> <option value="2">2h</option> </select> </div>
                    </div>
                    <button id="btn-salvar-cliente" class="btn-primary" onclick="salvarCliente()">Guardar Cliente</button>
                    <button id="btn-cancelar-edicao" class="btn-danger" onclick="cancelarEdicao()" style="display:none;">Cancelar</button>
                </div>
                <div class="panel table-responsive">
                    <table id="tabela-clientes-root">
                        <thead><tr><th>Nome</th><th>Contacto</th><th>Freq.</th><th>Dura√ß√£o</th><th>A√ß√µes</th></tr></thead>
                        <tbody id="tabela-clientes"></tbody>
                    </table>
                </div>
            </div>

            <div id="faturacao" class="section">
                <h1>Fatura√ß√£o</h1>
                <div class="panel">
                    <div class="mes-header">
                        <input type="month" id="input-mes" onchange="renderFaturacao()">
                        <div style="text-align:right;">Total: <span class="faturacao-total" id="total-faturado-mes">0.00 ‚Ç¨</span></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex:2;"><label>Cliente</label><select id="select-cliente-faturacao"></select></div>
                        <div class="form-group" style="flex:1;"><label>Valor (‚Ç¨)</label><input type="number" id="input-preco-faturacao" step="0.5"></div>
                        <button class="btn-success" onclick="addFaturacao()">Registar</button>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Cliente</th><th>Valor</th><th>A√ß√µes</th></tr></thead>
                            <tbody id="tabela-faturacao"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="config" class="section">
                <h1>Configura√ß√µes</h1>
                <div class="panel">
                    <div class="form-grid">
                        <div class="form-group"><label>Horas/Dia</label><input type="number" id="config-horas-dia"></div>
                        <div class="form-group"><label>Dias/Semana</label><input type="number" id="config-dias-semana"></div>
                    </div>
                    <button class="btn-accent" onclick="salvarConfig()">Atualizar Hor√°rio</button>
                </div>
                <button class="btn-danger" onclick="fazerLogout()">Sair da Conta (Logout)</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://bxqlqexumitvhzbuuhpj.supabase.co";
        const SUPABASE_KEY = "sb_publishable_3fQhn8sBTNDXEjpk3SAPXQ_UddrAIH6";
        const supabaseDB = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let clientes = [], faturacaoDB = [], agendaDB = [], idEmEdicao = null;
        let config = { id: 1, horas_dia: 8, dias_semana: 5 };

        window.onload = async function() {
            const { data: { session } } = await supabaseDB.auth.getSession();
            if (session) entrarNoApp();
        };

        async function verificarLogin() {
            const email = document.getElementById('input-email').value;
            const password = document.getElementById('input-password').value;
            mostrarLoading(true);
            const { error } = await supabaseDB.auth.signInWithPassword({ email, password });
            if (error) { mostrarLoading(false); alert("Erro no Login!"); } else { entrarNoApp(); }
        }

        function entrarNoApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-interface').style.display = 'flex';
            sincronizarComServidor();
        }

        async function fazerLogout() { await supabaseDB.auth.signOut(); window.location.reload(); }

        function mostrarLoading(m) { document.getElementById('loading-screen').style.display = m ? 'flex' : 'none'; }

        async function sincronizarComServidor() {
            mostrarLoading(true);
            const [resC, resF, resA, resConf] = await Promise.all([
                supabaseDB.from('clientes').select('*').order('nome'),
                supabaseDB.from('faturacao').select('*'),
                supabaseDB.from('agenda').select('*'),
                supabaseDB.from('config').select('*').eq('id', 1).single()
            ]);
            clientes = resC.data || []; faturacaoDB = resF.data || []; agendaDB = resA.data || [];
            if(resConf.data) config = resConf.data;
            renderTudo();
            mostrarLoading(false);
        }

        function renderTudo() {
            const tbodyC = document.getElementById('tabela-clientes');
            tbodyC.innerHTML = ''; let horasMes = 0;
            const selA = document.getElementById('select-cliente-agenda');
            const selF = document.getElementById('select-cliente-faturacao');
            selA.innerHTML = selF.innerHTML = '<option value="">-- Selecionar --</option>';

            clientes.forEach(c => {
                horasMes += (4 / c.frequencia) * c.duracao;
                selA.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                selF.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                
                tbodyC.innerHTML += `<tr>
                    <td><b>${c.nome}</b></td>
                    <td>${c.telefone || '-'}</td>
                    <td>${c.frequencia} sem.</td>
                    <td>${c.duracao}h</td>
                    <td>
                        <button class="btn-accent btn-small" onclick="carregarParaEdicao('${c.id}')">Editar</button>
                        <button class="btn-danger btn-small" onclick="apagarCliente('${c.id}')">Apagar</button>
                    </td>
                </tr>`;
            });

            const totalHoras = config.horas_dia * config.dias_semana * 4;
            document.getElementById('dash-total-clientes').innerText = clientes.length;
            document.getElementById('dash-horas-ocupadas').innerText = horasMes.toFixed(1) + 'h';
            document.getElementById('dash-vagas').innerText = Math.max(0, totalHoras - horasMes).toFixed(1) + 'h';
            const perc = Math.min(100, (horasMes / totalHoras) * 100);
            document.getElementById('barra-ocupacao').style.width = perc + '%';
            document.getElementById('texto-ocupacao').innerText = perc.toFixed(1) + '%';
            renderAgenda(); renderFaturacao();
        }

        function renderAgenda() {
    const dia = document.getElementById('input-data-agenda').value;
    const tbody = document.getElementById('tabela-agenda');
    tbody.innerHTML = '';
    
    // Formata a data para DD/MM (ex: 25/02)
    const dataFormatada = dia.split('-').reverse().slice(0,2).join('/');

    agendaDB.filter(a => a.dia === dia).sort((x,y) => x.hora.localeCompare(y.hora)).forEach(m => {
        // Remove espa√ßos do n√∫mero para o link n√£o quebrar
        const numLimpo = m.telefone_snapshot ? m.telefone_snapshot.replace(/\s/g, '') : '';
        
        // Texto da mensagem
        const textoChat = `Al√¥ ${m.nome_snapshot}, confirmo a tua marca√ß√£o para o dia ${dataFormatada} √†s ${m.hora}. Beijinhos! ‚ú®`;
        
        // Link usando o formato oficial wa.me com a mensagem encodada
        const linkWpp = numLimpo ? `<a href="https://wa.me/351${numLimpo}?text=${encodeURIComponent(textoChat)}" target="_blank" class="btn-whatsapp btn-small" style="text-decoration:none; display:inline-block;">üì± WhatsApp</a>` : '';
        
        tbody.innerHTML += `<tr>
            <td>${m.hora}</td>
            <td>${m.nome_snapshot}</td>
            <td>${m.servico || '-'}</td>
            <td>${m.telefone_snapshot || '-'}</td>
            <td>
                ${linkWpp}
                <button class="btn-danger btn-small" onclick="apagarAgenda('${m.id}')">Remover</button>
            </td>
        </tr>`;
    });
}
        function renderFaturacao() {
            const mes = document.getElementById('input-mes').value;
            const tbody = document.getElementById('tabela-faturacao');
            tbody.innerHTML = ''; let total = 0;
            faturacaoDB.filter(f => f.mes === mes).forEach(r => {
                total += r.preco;
                tbody.innerHTML += `<tr><td>${r.nome_snapshot}</td><td>${r.preco.toFixed(2)} ‚Ç¨</td><td><button class="btn-danger btn-small" onclick="apagarFaturacao('${r.id}')">X</button></td></tr>`;
            });
            document.getElementById('total-faturado-mes').innerText = total.toFixed(2) + ' ‚Ç¨';
        }

        async function salvarCliente() {
            const n = document.getElementById('nome').value, t = document.getElementById('telefone').value;
            const f = parseInt(document.getElementById('frequencia').value), d = parseFloat(document.getElementById('duracao').value);
            if(!n || isNaN(d)) return;
            mostrarLoading(true);
            if(idEmEdicao) await supabaseDB.from('clientes').update({nome:n, telefone:t, frequencia:f, duracao:d}).eq('id', idEmEdicao);
            else await supabaseDB.from('clientes').insert([{nome:n, telefone:t, frequencia:f, duracao:d}]);
            cancelarEdicao(); sincronizarComServidor();
        }

        async function apagarCliente(id) {
            if(!confirm("Tens a certeza que queres apagar este cliente?")) return;
            mostrarLoading(true);
            await supabaseDB.from('clientes').delete().eq('id', id);
            sincronizarComServidor();
        }

        function carregarParaEdicao(id) {
            const c = clientes.find(x => x.id === id);
            document.getElementById('nome').value = c.nome; 
            document.getElementById('telefone').value = c.telefone;
            document.getElementById('frequencia').value = c.frequencia;
            document.getElementById('duracao').value = c.duracao;
            idEmEdicao = id; 
            document.getElementById('btn-cancelar-edicao').style.display = 'inline';
        }

        function cancelarEdicao() { 
            idEmEdicao = null; 
            document.getElementById('nome').value = ''; 
            document.getElementById('telefone').value = '';
            document.getElementById('frequencia').value = "4"; 
            document.getElementById('duracao').value = "1";   
            document.getElementById('btn-cancelar-edicao').style.display = 'none'; 
        }

        async function addAgenda() {
            const d = document.getElementById('input-data-agenda').value;
            const h = document.getElementById('input-hora-agenda').value;
            const s = document.getElementById('select-servico-agenda').value;
            const id = document.getElementById('select-cliente-agenda').value;
            if(!d || !h || !id) return;
            const c = clientes.find(x => x.id === id);
            await supabaseDB.from('agenda').insert([{
                dia:d, 
                hora:h, 
                servico:s, 
                id_cliente:id, 
                nome_snapshot:c.nome, 
                telefone_snapshot:c.telefone
            }]);
            sincronizarComServidor();
        }

        async function apagarAgenda(id) { await supabaseDB.from('agenda').delete().eq('id', id); sincronizarComServidor(); }

        async function addFaturacao() {
            const m = document.getElementById('input-mes').value, p = parseFloat(document.getElementById('input-preco-faturacao').value), id = document.getElementById('select-cliente-faturacao').value;
            if(!m || isNaN(p) || !id) return;
            const c = clientes.find(x => x.id === id);
            await supabaseDB.from('faturacao').insert([{mes:m, preco:p, id_cliente:id, nome_snapshot:c.nome}]);
            sincronizarComServidor();
        }

        async function apagarFaturacao(id) { await supabaseDB.from('faturacao').delete().eq('id', id); sincronizarComServidor(); }

        async function salvarConfig() {
            const h = document.getElementById('config-horas-dia').value, d = document.getElementById('config-dias-semana').value;
            await supabaseDB.from('config').update({horas_dia:h, dias_semana:d}).eq('id', 1);
            sincronizarComServidor();
        }

        function mudarAba(id, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(id).classList.add('active'); el.classList.add('active');
        }

        const hoje = new Date();
        document.getElementById('input-mes').value = hoje.getFullYear() + "-" + String(hoje.getMonth() + 1).padStart(2, '0');
        document.getElementById('input-data-agenda').value = hoje.toISOString().split('T')[0];
    </script>
</body>
</html>



