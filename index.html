<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mariana Pereira | Business Management</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1e293b; /* Slate Blue Dark */
            --accent: #d4af37; /* Gold */
            --accent-hover: #b8962d;
            --bg-body: #f1f5f9;
            --sidebar-width: 260px;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--bg-body); color: #1e293b; display: flex; height: 100vh; overflow: hidden; }

        /* LOGIN REDESIGN */
        #login-screen {
            position: fixed; inset: 0; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .login-box { 
            background: white; padding: 3rem; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); 
            text-align: center; width: 90%; max-width: 420px; border: 1px solid rgba(255,255,255,0.1);
        }
        .login-box h2 { font-size: 1.8rem; font-weight: 800; color: var(--primary); margin-bottom: 0.5rem; letter-spacing: -1px; }
        .login-box p { color: #64748b; margin-bottom: 2rem; }
        .login-box input { 
            width: 100%; padding: 14px; margin-bottom: 1rem; border: 2px solid #e2e8f0; border-radius: 12px;
            font-size: 1rem; transition: var(--transition); outline: none;
        }
        .login-box input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1); }
        .login-box button { 
            width: 100%; padding: 14px; background: var(--accent); color: white; border: none; 
            border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: var(--transition);
        }
        .login-box button:hover { background: var(--accent-hover); transform: translateY(-2px); }

        /* SIDEBAR PREMIUM */
        .sidebar { 
            width: var(--sidebar-width); background: var(--primary); color: white; 
            display: flex; flex-direction: column; padding: 2rem 1rem; flex-shrink: 0;
            box-shadow: 4px 0 10px rgba(0,0,0,0.05);
        }
        .logo { 
            font-size: 1.2rem; font-weight: 900; color: var(--accent); margin-bottom: 3rem; 
            text-align: center; text-transform: uppercase; letter-spacing: 2px;
        }
        .menu-item { 
            padding: 12px 16px; cursor: pointer; transition: var(--transition); 
            font-size: 0.95rem; border-radius: 10px; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 12px;
            color: #94a3b8;
        }
        .menu-item i { width: 20px; text-align: center; font-size: 1.1rem; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.05); color: var(--accent); }
        .menu-item.active { background: rgba(212, 175, 55, 0.1); font-weight: 600; }

        /* CONTENT AREA */
        .main-content { flex: 1; padding: 2.5rem; overflow-y: auto; scroll-behavior: smooth; }
        .section { display: none; animation: slideUp 0.5s ease-out; }
        .section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1 { font-size: 2rem; font-weight: 800; color: var(--primary); margin-bottom: 2rem; letter-spacing: -1px; }

        /* CARDS & PANELS */
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem; }
        .card { 
            background: white; padding: 1.5rem; border-radius: 16px; box-shadow: var(--card-shadow); 
            border-bottom: 4px solid var(--accent); transition: var(--transition);
        }
        .card:hover { transform: translateY(-5px); }
        .card h3 { font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; }
        .card .value { font-size: 2.2rem; font-weight: 800; color: var(--primary); }

        .panel { 
            background: white; padding: 2rem; border-radius: 20px; box-shadow: var(--card-shadow); 
            margin-bottom: 2rem; border: 1px solid #f1f5f9;
        }
        .panel h3 { margin-bottom: 1.5rem; font-weight: 700; color: var(--primary); }

        /* FORM ELEMENTS */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.25rem; }
        .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 1rem; }
        label { font-size: 0.85rem; font-weight: 700; color: #475569; }
        input, select { 
            padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; 
            outline: none; transition: var(--transition); background: #f8fafc;
        }
        input:focus, select:focus { border-color: var(--accent); background: white; }

        /* BUTTONS */
        button { 
            padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; 
            font-weight: 700; font-size: 0.9rem; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-whatsapp { background: #22c55e; color: white; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        /* TABLES */
        .table-responsive { border-radius: 16px; overflow: hidden; border: 1px solid #e2e8f0; margin-top: 1rem;}
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8fafc; color: #64748b; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; padding: 16px; text-align: left; }
        td { padding: 16px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: #f8fafc; }

        /* LOADING SPINNER */
        #loading-screen {
            position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px);
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9998;
        }
        .spinner { border: 4px solid #e2e8f0; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }

        /* MOBILE OPTIMIZATION */
        @media (max-width: 1024px) {
            body { flex-direction: column; }
            .sidebar { 
                width: 100%; height: auto; flex-direction: row; padding: 0.5rem; 
                position: fixed; bottom: 0; left: 0; z-index: 1000; overflow-x: auto;
            }
            .logo { display: none; }
            .menu-item { margin: 0; flex: 1; flex-direction: column; font-size: 0.7rem; gap: 4px; border-radius: 8px; }
            .main-content { padding: 1.5rem; padding-bottom: 100px; }
            h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <div style="font-size: 3rem; margin-bottom: 1rem;">✨</div>
            <h2>Mariana Pereira</h2>
            <p>Sessão de Gestão Profissional</p>
            <input type="email" id="input-email" placeholder="Endereço de Email">
            <input type="password" id="input-password" placeholder="Palavra-passe">
            <button onclick="verificarLogin()">Entrar no Sistema</button>
        </div>
    </div>

    <div id="loading-screen">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-weight: 600; color: var(--primary);">Sincronizando dados...</p>
    </div>

    <div id="app-interface">
        <nav class="sidebar">
            <div class="logo">Mariana P.</div>
            <div class="menu-item active" onclick="mudarAba('dashboard', this)"><i class="fa-solid fa-chart-pie"></i> Painel</div>
            <div class="menu-item" onclick="mudarAba('agenda', this)"><i class="fa-solid fa-calendar-days"></i> Agenda</div>
            <div class="menu-item" onclick="mudarAba('clientes', this)"><i class="fa-solid fa-users"></i> Clientes</div>
            <div class="menu-item" onclick="mudarAba('precos-tab', this)"><i class="fa-solid fa-tag"></i> Tabela Preços</div>
            <div class="menu-item" onclick="mudarAba('faturacao', this)"><i class="fa-solid fa-receipt"></i> Faturação</div>
            <div class="menu-item" onclick="mudarAba('config', this)"><i class="fa-solid fa-sliders"></i> Ajustes</div>
        </nav>

        <main class="main-content">
            <div id="dashboard" class="section active">
                <h1>Painel de Visão Geral</h1>
                <div class="dashboard-cards">
                    <div class="card">
                        <h3>Clientes Ativos</h3>
                        <div class="value" id="dash-total-clientes">0</div>
                    </div>
                    <div class="card">
                        <h3>Ocupação Mensal</h3>
                        <div class="value" id="dash-horas-ocupadas">0h</div>
                    </div>
                    <div class="card">
                        <h3>Vagas Disponíveis</h3>
                        <div class="value" id="dash-vagas" style="color:#10b981;">0h</div>
                    </div>
                </div>
                <div class="panel">
                    <h3>Performance de Capacidade</h3>
                    <div class="progress-container" style="height:12px; background:#f1f5f9; border-radius:10px; overflow:hidden;">
                        <div class="progress-bar" id="barra-ocupacao" style="width: 0%; height:100%; background:var(--accent); transition: width 1s;"></div>
                    </div>
                    <p style="margin-top:1rem; font-weight:700; color:var(--primary);" id="texto-ocupacao">0% da capacidade utilizada</p>
                </div>
            </div>

            <div id="agenda" class="section">
                <h1>Calendário de Trabalho</h1>
                <div class="panel">
                    <div class="form-row" style="margin-bottom:2rem;">
                        <div class="form-group"><label>Data de Visualização</label><input type="date" id="input-data-agenda" onchange="renderAgenda()"></div>
                    </div>
                    <div class="form-grid" style="background:#f8fafc; padding:1.5rem; border-radius:16px; margin-bottom:2rem;">
                        <div class="form-group"><label>Cliente</label><select id="select-cliente-agenda"></select></div>
                        <div class="form-group"><label>Serviço Selecionado</label><select id="select-servico-agenda"></select></div>
                        <div class="form-group"><label>Horário</label><input type="time" id="input-hora-agenda"></div>
                        <div class="form-group" style="justify-content: flex-end;"><button class="btn-accent" style="width:100%" onclick="addAgenda()"><i class="fa-solid fa-plus"></i> Agendar & Faturar</button></div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Hora</th><th>Cliente</th><th>Serviço</th><th>Contacto</th><th>Ações</th></tr></thead>
                            <tbody id="tabela-agenda"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="clientes" class="section">
                <h1>Base de Clientes</h1>
                <div class="panel">
                    <div class="form-grid">
                        <div class="form-group"><label>Nome Completo</label><input type="text" id="nome"></div>
                        <div class="form-group"><label>Telemóvel</label><input type="text" id="telefone"></div>
                        <div class="form-group"><label>Frequência (Semanas)</label><select id="frequencia"><option value="3">3 Semanas</option><option value="4" selected>4 Semanas</option><option value="5">5 Semanas</option></select></div>
                        <div class="form-group"><label>Tempo de Serviço</label><select id="duracao"><option value="1">1 Hora</option><option value="1.5">1.5 Horas</option><option value="2">2 Horas</option></select></div>
                    </div>
                    <div style="margin-top:1.5rem; display:flex; gap:10px;">
                        <button id="btn-salvar-cliente" class="btn-primary" onclick="salvarCliente()"><i class="fa-solid fa-floppy-disk"></i> Registar Cliente</button>
                        <button id="btn-cancelar-edicao" class="btn-danger" onclick="cancelarEdicao()" style="display:none;">Cancelar</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Nome</th><th>Contacto</th><th>Ritmo</th><th>Duração</th><th>Gestão</th></tr></thead>
                        <tbody id="tabela-clientes"></tbody>
                    </table>
                </div>
            </div>

            <div id="precos-tab" class="section">
                <h1>Catálogo de Serviços</h1>
                <div class="panel">
                    <div class="form-grid">
                        <div class="form-group"><label>Nome do Procedimento</label><input type="text" id="novo-servico-nome"></div>
                        <div class="form-group"><label>Valor de Tabela (€)</label><input type="number" id="novo-servico-preco" step="0.5"></div>
                        <div class="form-group" style="justify-content: flex-end;"><button class="btn-success" style="width:100%" onclick="salvarServico()"><i class="fa-solid fa-check"></i> Atualizar Tabela</button></div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Serviço</th><th>Preço</th><th>Ações</th></tr></thead>
                        <tbody id="tabela-precos"></tbody>
                    </table>
                </div>
            </div>

            <div id="faturacao" class="section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <h1>Relatório Financeiro</h1>
                    <div class="card" style="padding:10px 25px; border-bottom:none; border-left:4px solid #10b981;">
                        <h3 style="margin:0">Total Mensal</h3>
                        <div class="value" id="total-faturado-mes" style="font-size:1.5rem">0.00 €</div>
                    </div>
                </div>
                <div class="panel">
                    <div class="form-group" style="max-width:300px;"><label>Período de Análise</label><input type="month" id="input-mes" onchange="renderFaturacao()"></div>
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Cliente</th><th>Serviço Prestado</th><th>Valor</th><th>Ações</th></tr></thead>
                            <tbody id="tabela-faturacao"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="config" class="section">
                <h1>Configurações do Sistema</h1>
                <div class="panel">
                    <div class="form-grid">
                        <div class="form-group"><label>Horário Útil (Horas/Dia)</label><input type="number" id="config-horas-dia"></div>
                        <div class="form-group"><label>Dias Úteis (Semana)</label><input type="number" id="config-dias-semana"></div>
                    </div>
                    <button class="btn-accent" style="margin-top:1.5rem" onclick="salvarConfig()"><i class="fa-solid fa-rotate"></i> Atualizar Parametrização</button>
                </div>
                <button class="btn-danger" onclick="fazerLogout()"><i class="fa-solid fa-right-from-bracket"></i> Encerrar Sessão</button>
            </div>
        </main>
    </div>

    <script>
        /* MANTEMOS A TUA LÓGICA DE PROGRAMAÇÃO INTACTA */
        const SUPABASE_URL = "https://bxqlqexumitvhzbuuhpj.supabase.co";
        const SUPABASE_KEY = "sb_publishable_3fQhn8sBTNDXEjpk3SAPXQ_UddrAIH6";
        const supabaseDB = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let clientes = [], faturacaoDB = [], agendaDB = [], servicosDB = [], idEmEdicao = null, idServicoEdicao = null;
        let config = { id: 1, horas_dia: 8, dias_semana: 5 };

        window.onload = async function() {
            const { data: { session } } = await supabaseDB.auth.getSession();
            if (session) entrarNoApp();
        };

        async function verificarLogin() {
            const email = document.getElementById('input-email').value;
            const password = document.getElementById('input-password').value;
            mostrarLoading(true);
            const { error } = await supabaseDB.auth.signInWithPassword({ email, password });
            if (error) { mostrarLoading(false); alert("Dados incorretos!"); } else { entrarNoApp(); }
        }

        function entrarNoApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-interface').style.display = 'flex';
            sincronizarComServidor();
        }

        async function fazerLogout() { await supabaseDB.auth.signOut(); window.location.reload(); }
        function mostrarLoading(m) { document.getElementById('loading-screen').style.display = m ? 'flex' : 'none'; }

        async function sincronizarComServidor() {
            mostrarLoading(true);
            const [resC, resF, resA, resConf, resS] = await Promise.all([
                supabaseDB.from('clientes').select('*').order('nome'),
                supabaseDB.from('faturacao').select('*'),
                supabaseDB.from('agenda').select('*'),
                supabaseDB.from('config').select('*').eq('id', 1).single(),
                supabaseDB.from('servicos').select('*').order('nome')
            ]);
            clientes = resC.data || []; faturacaoDB = resF.data || []; agendaDB = resA.data || [];
            servicosDB = resS.data || [];
            if(resConf.data) config = resConf.data;
            renderTudo();
            mostrarLoading(false);
        }

        function renderTudo() {
            const tbodyC = document.getElementById('tabela-clientes');
            tbodyC.innerHTML = ''; let horasMes = 0;
            const selA = document.getElementById('select-cliente-agenda');
            const selS = document.getElementById('select-servico-agenda');
            selA.innerHTML = '<option value="">Escolher Cliente...</option>';
            selS.innerHTML = '<option value="">Escolher Serviço...</option>';

            clientes.forEach(c => {
                horasMes += (4 / c.frequencia) * c.duracao;
                selA.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                tbodyC.innerHTML += `<tr><td><b>${c.nome}</b></td><td>${c.telefone || '-'}</td><td>${c.frequencia} sem.</td><td>${c.duracao}h</td><td><button class="btn-primary btn-small" onclick="carregarParaEdicao('${c.id}')"><i class="fa-solid fa-pen"></i></button><button class="btn-danger btn-small" onclick="apagarCliente('${c.id}')"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });

            servicosDB.forEach(s => {
                selS.innerHTML += `<option value="${s.nome}" data-preco="${s.preco}">${s.nome} (${s.preco}€)</option>`;
            });

            renderPrecos();
            const totalHoras = config.horas_dia * config.dias_semana * 4;
            document.getElementById('dash-total-clientes').innerText = clientes.length;
            document.getElementById('dash-horas-ocupadas').innerText = horasMes.toFixed(1) + 'h';
            document.getElementById('dash-vagas').innerText = Math.max(0, totalHoras - horasMes).toFixed(1) + 'h';
            const perc = Math.min(100, (horasMes / totalHoras) * 100);
            document.getElementById('barra-ocupacao').style.width = perc + '%';
            document.getElementById('texto-ocupacao').innerText = perc.toFixed(1) + '% da capacidade utilizada';
            renderAgenda(); renderFaturacao();
        }

        function renderPrecos() {
            const tbody = document.getElementById('tabela-precos');
            tbody.innerHTML = '';
            servicosDB.forEach(s => {
                tbody.innerHTML += `<tr><td><b>${s.nome}</b></td><td>${s.preco.toFixed(2)} €</td><td><button class="btn-primary btn-small" onclick="carregarServicoEdicao('${s.id}')"><i class="fa-solid fa-pen"></i></button><button class="btn-danger btn-small" onclick="apagarServico('${s.id}')"><i class="fa-solid fa-xmark"></i></button></td></tr>`;
            });
        }

        async function salvarServico() {
            const n = document.getElementById('novo-servico-nome').value, p = parseFloat(document.getElementById('novo-servico-preco').value);
            if(!n || isNaN(p)) return;
            mostrarLoading(true);
            if(idServicoEdicao) await supabaseDB.from('servicos').update({nome:n, preco:p}).eq('id', idServicoEdicao);
            else await supabaseDB.from('servicos').insert([{nome:n, preco:p}]);
            idServicoEdicao = null;
            document.getElementById('novo-servico-nome').value = ''; document.getElementById('novo-servico-preco').value = '';
            sincronizarComServidor();
        }

        function carregarServicoEdicao(id) {
            const s = servicosDB.find(x => x.id == id);
            document.getElementById('novo-servico-nome').value = s.nome;
            document.getElementById('novo-servico-preco').value = s.preco;
            idServicoEdicao = id;
        }

        async function apagarServico(id) { if(confirm("Apagar serviço?")) { await supabaseDB.from('servicos').delete().eq('id', id); sincronizarComServidor(); } }

        function renderAgenda() {
            const dia = document.getElementById('input-data-agenda').value;
            const tbody = document.getElementById('tabela-agenda');
            tbody.innerHTML = '';
            const dataFormatada = dia.split('-').reverse().slice(0,2).join('/');
            agendaDB.filter(a => a.dia === dia).sort((x,y) => x.hora.localeCompare(y.hora)).forEach(m => {
                const numLimpo = m.telefone_snapshot ? m.telefone_snapshot.replace(/\s/g, '') : '';
                const textoChat = `Alô ${m.nome_snapshot}, envio mensagem para recordar a marcação de dia ${dataFormatada} às ${m.hora}. Agradeço confirmação. Beijinho! ✨`;
                const linkWpp = numLimpo ? `<a href="https://wa.me/351${numLimpo}?text=${encodeURIComponent(textoChat)}" target="_blank" class="btn-whatsapp btn-small" style="text-decoration:none;"><i class="fa-brands fa-whatsapp"></i> Relembrar</a>` : '';
                tbody.innerHTML += `<tr><td><b>${m.hora}</b></td><td>${m.nome_snapshot}</td><td><span style="background:#f1f5f9; padding:4px 8px; border-radius:6px; font-size:0.8rem">${m.servico}</span></td><td>${m.telefone_snapshot || '-'}</td><td>${linkWpp}<button class="btn-danger btn-small" onclick="apagarAgenda('${m.id}')"><i class="fa-solid fa-trash-can"></i></button></td></tr>`;
            });
        }

        function renderFaturacao() {
            const mes = document.getElementById('input-mes').value;
            const tbody = document.getElementById('tabela-faturacao');
            tbody.innerHTML = ''; let total = 0;
            faturacaoDB.filter(f => f.mes === mes).forEach(r => {
                total += r.preco;
                tbody.innerHTML += `<tr><td><b>${r.nome_snapshot}</b></td><td>${r.servico_snapshot || '-'}</td><td><span style="color:#10b981; font-weight:700">${r.preco.toFixed(2)} €</span></td><td><button class="btn-danger btn-small" onclick="apagarFaturacao('${r.id}')"><i class="fa-solid fa-xmark"></i></button></td></tr>`;
            });
            document.getElementById('total-faturado-mes').innerText = total.toFixed(2) + ' €';
        }

        async function addAgenda() {
            const d = document.getElementById('input-data-agenda').value;
            const h = document.getElementById('input-hora-agenda').value;
            const selS = document.getElementById('select-servico-agenda');
            const sNome = selS.value;
            const sPreco = parseFloat(selS.options[selS.selectedIndex]?.getAttribute('data-preco'));
            const idC = document.getElementById('select-cliente-agenda').value;

            if(!d || !h || !idC || !sNome) { alert("Preenche todos os campos!"); return; }
            
            mostrarLoading(true);
            const c = clientes.find(x => x.id === idC);
            const mesAtual = d.substring(0, 7);

            const { error: errA } = await supabaseDB.from('agenda').insert([{ dia:d, hora:h, servico:sNome, id_cliente:idC, nome_snapshot:c.nome, telefone_snapshot:c.telefone }]);
            const { error: errF } = await supabaseDB.from('faturacao').insert([{ mes: mesAtual, preco: sPreco, id_cliente: idC, nome_snapshot: c.nome, servico_snapshot: sNome }]);

            sincronizarComServidor();
        }

        async function salvarCliente() {
            const n = document.getElementById('nome').value, t = document.getElementById('telefone').value;
            const f = parseInt(document.getElementById('frequencia').value), d = parseFloat(document.getElementById('duracao').value);
            if(!n || isNaN(d)) return;
            mostrarLoading(true);
            if(idEmEdicao) await supabaseDB.from('clientes').update({nome:n, telefone:t, frequencia:f, duracao:d}).eq('id', idEmEdicao);
            else await supabaseDB.from('clientes').insert([{nome:n, telefone:t, frequencia:f, duracao:d}]);
            cancelarEdicao(); sincronizarComServidor();
        }

        async function apagarCliente(id) { if(confirm("Apagar cliente?")) { mostrarLoading(true); await supabaseDB.from('clientes').delete().eq('id', id); sincronizarComServidor(); } }
        function carregarParaEdicao(id) { 
            const c = clientes.find(x => x.id === id); 
            document.getElementById('nome').value = c.nome; document.getElementById('telefone').value = c.telefone;
            document.getElementById('frequencia').value = c.frequencia; document.getElementById('duracao').value = c.duracao;
            idEmEdicao = id; document.getElementById('btn-cancelar-edicao').style.display = 'inline-flex';
            document.getElementById('btn-salvar-cliente').innerHTML = '<i class="fa-solid fa-check"></i> Atualizar Dados';
        }
        function cancelarEdicao() { idEmEdicao = null; document.getElementById('nome').value = ''; document.getElementById('telefone').value = ''; document.getElementById('btn-cancelar-edicao').style.display = 'none'; document.getElementById('btn-salvar-cliente').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Registar Cliente'; }
        async function apagarAgenda(id) { await supabaseDB.from('agenda').delete().eq('id', id); sincronizarComServidor(); }
        async function apagarFaturacao(id) { await supabaseDB.from('faturacao').delete().eq('id', id); sincronizarComServidor(); }
        async function salvarConfig() {
            const h = document.getElementById('config-horas-dia').value, d = document.getElementById('config-dias-semana').value;
            await supabaseDB.from('config').update({horas_dia:h, dias_semana:d}).eq('id', 1);
            sincronizarComServidor();
        }
        function mudarAba(id, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(id).classList.add('active'); el.classList.add('active');
        }

        const hoje = new Date();
        document.getElementById('input-mes').value = hoje.getFullYear() + "-" + String(hoje.getMonth() + 1).padStart(2, '0');
        document.getElementById('input-data-agenda').value = hoje.toISOString().split('T')[0];
    </script>
</body>
</html>
