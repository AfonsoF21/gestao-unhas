<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mariana Pereira | Sistema de Gestão</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #0f172a; /* Slate 900 */
            --primary: #1e293b; /* Slate 800 */
            --accent: #D4AF37; /* Gold Premium */
            --accent-hover: #b8962d;
            --bg-app: #f1f5f9; /* Slate 100 */
            --bg-panel: #ffffff;
            --text-main: #334155; /* Slate 700 */
            --text-muted: #64748b; /* Slate 500 */
            --border-color: #e2e8f0; /* Slate 200 */
            --sidebar-width: 260px;
            --topbar-height: 70px;
            --transition: all 0.2s ease-in-out;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body { 
            background-color: var(--bg-app); color: var(--text-main); 
            display: flex; width: 100vw; height: 100vh; overflow: hidden;
        }

        /* --- TELA DE LOGIN --- */
        #login-screen {
            position: fixed; inset: 0; background: var(--primary-dark);
            display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .login-box { 
            background: var(--bg-panel); padding: 3.5rem 3rem; border-radius: 12px; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); 
            text-align: center; width: 100%; max-width: 440px;
        }
        .login-box h2 { font-size: 1.75rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 0.5rem; }
        .login-box p { color: var(--text-muted); margin-bottom: 2.5rem; font-size: 0.95rem; }
        .login-box input { 
            width: 100%; padding: 14px 16px; margin-bottom: 1.2rem; border: 1px solid var(--border-color); 
            border-radius: 8px; font-size: 1rem; outline: none; transition: var(--transition);
            background-color: #f8fafc;
        }
        .login-box input:focus { border-color: var(--accent); background-color: #fff; box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15); }
        .login-box button { 
            width: 100%; padding: 14px; background: var(--primary-dark); color: white; border: none; 
            border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: var(--transition);
        }
        .login-box button:hover { background: var(--accent); }

        /* --- LOADING --- */
        #loading-screen {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9998;
        }
        .spinner { border: 3px solid var(--border-color); border-top: 3px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- APP SHELL (ESTRUTURA DESKTOP FULL WIDTH) --- */
        #app-interface { display: none; width: 100vw; height: 100vh; }
        
        /* SIDEBAR LATERAL */
        .sidebar { 
            width: var(--sidebar-width); background: var(--primary-dark); color: white; 
            display: flex; flex-direction: column; flex-shrink: 0; height: 100vh;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        .sidebar-header {
            height: var(--topbar-height); display: flex; align-items: center; padding: 0 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 1.5rem;
        }
        .sidebar-header .logo { font-size: 1.25rem; font-weight: 700; color: white; letter-spacing: 1px; }
        .sidebar-header .logo span { color: var(--accent); }
        
        .menu-item { 
            padding: 14px 1.5rem; cursor: pointer; transition: var(--transition); 
            font-size: 0.95rem; display: flex; align-items: center; gap: 14px;
            color: #94a3b8; font-weight: 500; border-left: 3px solid transparent;
        }
        .menu-item i { width: 20px; font-size: 1.1rem; text-align: center; }
        .menu-item:hover { color: white; background: rgba(255,255,255,0.03); }
        .menu-item.active { background: linear-gradient(90deg, rgba(212,175,55,0.1) 0%, transparent 100%); color: var(--accent); border-left-color: var(--accent); }

        /* ÁREA PRINCIPAL DA DIREITA */
        .main-wrapper {
            flex: 1; display: flex; flex-direction: column; height: 100vh; background: var(--bg-app);
            overflow: hidden;
        }

        /* TOPBAR (CABEÇALHO) */
        .topbar {
            height: var(--topbar-height); background: var(--bg-panel); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; padding: 0 2.5rem; flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .topbar-title { font-size: 1.25rem; font-weight: 600; color: var(--primary-dark); }
        .topbar-actions { display: flex; align-items: center; gap: 1rem; }
        .topbar-date { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; }
        .user-avatar { 
            width: 36px; height: 36px; background: var(--primary); color: var(--accent); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; 
        }

        /* CONTEÚDO (SCROLLÁVEL) */
        .content-area { 
            flex: 1; padding: 2.5rem; overflow-y: auto; scroll-behavior: smooth; 
        }
        .section { display: none; animation: fadeIn 0.3s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- CARDS & PANELS FULL WIDTH --- */
        .dashboard-cards { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 1.5rem; margin-bottom: 2.5rem; width: 100%;
        }
        .card { 
            background: var(--bg-panel); padding: 1.5rem 2rem; border-radius: 8px; 
            border: 1px solid var(--border-color); display: flex; flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; overflow: hidden;
        }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary); }
        .card.highlight::before { background: var(--accent); }
        .card.success::before { background: #10b981; }
        .card h3 { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; font-weight: 600; }
        .card .value { font-size: 2.25rem; font-weight: 700; color: var(--primary-dark); }

        .panel { 
            background: var(--bg-panel); padding: 2rem; border-radius: 8px; 
            border: 1px solid var(--border-color); margin-bottom: 2rem; width: 100%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .panel-header { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .panel-header h3 { font-size: 1.1rem; font-weight: 600; color: var(--primary-dark); }

        /* --- FORMS CORPORATIVOS --- */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; align-items: end;}
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 0.85rem; font-weight: 600; color: var(--text-main); }
        input, select { 
            padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 6px; 
            font-size: 0.95rem; outline: none; transition: var(--transition); background: #fff;
            color: var(--text-main); width: 100%;
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.1); }

        /* --- BOTÕES --- */
        button { 
            padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; 
            font-weight: 500; font-size: 0.9rem; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary-dark); color: white; }
        .btn-primary:hover { background: var(--primary); }
        .btn-accent { background: var(--accent); color: white; }
        .btn-accent:hover { background: var(--accent-hover); }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-whatsapp { background: #10b981; color: white; background-color: rgba(16, 185, 129, 0.1); color: #10b981; font-weight: 600;}
        .btn-whatsapp:hover { background-color: #10b981; color: white;}
        .btn-icon { padding: 8px; min-width: 36px; border-radius: 6px; }

        /* --- TABELAS ENTERPRISE --- */
        .table-responsive { width: 100%; overflow-x: auto; margin-top: 1rem; border: 1px solid var(--border-color); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; background: white; white-space: nowrap; }
        th { 
            background: #f8fafc; color: var(--text-muted); font-weight: 600; 
            text-transform: uppercase; font-size: 0.75rem; padding: 14px 20px; text-align: left; 
            border-bottom: 1px solid var(--border-color); letter-spacing: 0.5px;
        }
        td { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; color: var(--text-main); }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f8fafc; }
        .badge { background: #f1f5f9; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; color: var(--text-muted); }
        .badge-green { background: rgba(16, 185, 129, 0.1); color: #10b981; }

        /* MOBILE ADJUSTMENTS (Para manter funcional no telemóvel, mas focado no PC) */
        @media (max-width: 1024px) {
            #app-interface { flex-direction: column; }
            .sidebar { width: 100%; height: auto; flex-direction: row; padding: 0; border-right: none; border-bottom: 1px solid #334155; overflow-x: auto; }
            .sidebar-header { display: none; }
            .menu-item { padding: 15px; border-left: none; border-bottom: 3px solid transparent; flex: 1; justify-content: center; }
            .menu-item.active { border-left-color: transparent; border-bottom-color: var(--accent); background: transparent; }
            .topbar { padding: 0 1.5rem; }
            .content-area { padding: 1.5rem; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Gestão Mariana P.</h2>
            <p>Por favor, autentique-se para aceder ao sistema</p>
            <input type="email" id="input-email" placeholder="Email corporativo">
            <input type="password" id="input-password" placeholder="Palavra-passe">
            <button onclick="verificarLogin()">Entrar Seguramente <i class="fa-solid fa-arrow-right" style="margin-left:5px"></i></button>
        </div>
    </div>

    <div id="loading-screen">
        <div class="spinner"></div>
    </div>

    <div id="app-interface">
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">Mariana<span>Pereira</span></div>
            </div>
            <div class="menu-item active" onclick="mudarAba('dashboard', 'Painel de Controlo', this)"><i class="fa-solid fa-chart-pie"></i> Dashboard</div>
            <div class="menu-item" onclick="mudarAba('agenda', 'Gestão de Agenda', this)"><i class="fa-solid fa-calendar-days"></i> Agenda</div>
            <div class="menu-item" onclick="mudarAba('clientes', 'Base de Clientes', this)"><i class="fa-solid fa-users"></i> Clientes</div>
            <div class="menu-item" onclick="mudarAba('precos-tab', 'Catálogo de Serviços', this)"><i class="fa-solid fa-tags"></i> Serviços</div>
            <div class="menu-item" onclick="mudarAba('faturacao', 'Faturação e Finanças', this)"><i class="fa-solid fa-file-invoice-dollar"></i> Faturação</div>
            <div class="menu-item" onclick="mudarAba('config', 'Parametrização', this)"><i class="fa-solid fa-gear"></i> Configurações</div>
        </nav>

        <div class="main-wrapper">
            <header class="topbar">
                <div class="topbar-title" id="page-title">Painel de Controlo</div>
                <div class="topbar-actions">
                    <span class="topbar-date" id="data-hoje"></span>
                    <div class="user-avatar">MP</div>
                </div>
            </header>

            <main class="content-area">
                
                <div id="dashboard" class="section active">
                    <div class="dashboard-cards">
                        <div class="card">
                            <h3>Total de Clientes</h3>
                            <div class="value" id="dash-total-clientes">0</div>
                        </div>
                        <div class="card highlight">
                            <h3>Ocupação Mensal (Horas)</h3>
                            <div class="value" id="dash-horas-ocupadas">0h</div>
                        </div>
                        <div class="card success">
                            <h3>Vagas Disponíveis</h3>
                            <div class="value" style="color: #10b981;" id="dash-vagas">0h</div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header"><h3>Métrica de Capacidade Mensal</h3></div>
                        <div style="height:10px; background:#e2e8f0; border-radius:5px; overflow:hidden; width:100%;">
                            <div id="barra-ocupacao" style="width: 0%; height:100%; background:var(--primary-dark); transition: width 1s ease-in-out;"></div>
                        </div>
                        <p style="margin-top:0.8rem; font-size:0.9rem; font-weight:600; color:var(--text-muted); text-align:right;" id="texto-ocupacao">0% utilizado</p>
                    </div>
                </div>

                <div id="agenda" class="section">
                    <div class="panel">
                        <div class="panel-header">
                            <h3>Nova Marcação</h3>
                            <input type="date" id="input-data-agenda" onchange="renderAgenda()" style="width: auto;">
                        </div>
                        <div class="form-grid">
                            <div class="form-group"><label>Cliente</label><select id="select-cliente-agenda"></select></div>
                            <div class="form-group"><label>Serviço (Preço Automático)</label><select id="select-servico-agenda"></select></div>
                            <div class="form-group"><label>Hora de Início</label><input type="time" id="input-hora-agenda"></div>
                            <div class="form-group"><button class="btn-primary" onclick="addAgenda()" style="height: 40px;"><i class="fa-solid fa-plus"></i> Guardar Marcação</button></div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header"><h3>Agenda do Dia</h3></div>
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Horário</th><th>Cliente</th><th>Serviço</th><th>Contacto</th><th>Ações</th></tr></thead>
                                <tbody id="tabela-agenda"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="clientes" class="section">
                    <div class="panel">
                        <div class="panel-header"><h3>Ficha de Cliente</h3></div>
                        <div class="form-grid">
                            <div class="form-group"><label>Nome Completo *</label><input type="text" id="nome"></div>
                            <div class="form-group"><label>Nº Telemóvel</label><input type="text" id="telefone"></div>
                            <div class="form-group"><label>Manutenção (Semanas)</label><select id="frequencia"><option value="3">3 Semanas</option><option value="4" selected>4 Semanas</option><option value="5">5 Semanas</option></select></div>
                            <div class="form-group"><label>Tempo Alocado (Horas)</label><select id="duracao"><option value="1">1 Hora</option><option value="1.5">1h 30m</option><option value="2">2 Horas</option></select></div>
                            <div class="form-group" style="flex-direction: row; gap: 10px;">
                                <button id="btn-salvar-cliente" class="btn-primary" style="flex:1" onclick="salvarCliente()"><i class="fa-solid fa-save"></i> Registar</button>
                                <button id="btn-cancelar-edicao" class="btn-danger" onclick="cancelarEdicao()" style="display:none;"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header"><h3>Listagem Ativa</h3></div>
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Nome</th><th>Telemóvel</th><th>Frequência</th><th>Duração</th><th>Ações</th></tr></thead>
                                <tbody id="tabela-clientes"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="precos-tab" class="section">
                    <div class="panel">
                        <div class="panel-header"><h3>Configurar Serviço</h3></div>
                        <div class="form-grid" style="grid-template-columns: 2fr 1fr auto;">
                            <div class="form-group"><label>Descrição do Serviço</label><input type="text" id="novo-servico-nome" placeholder="Ex: Manicure Gel"></div>
                            <div class="form-group"><label>Preço Base (€)</label><input type="number" id="novo-servico-preco" step="0.5"></div>
                            <div class="form-group"><button class="btn-primary" onclick="salvarServico()" style="height: 40px;"><i class="fa-solid fa-check"></i> Adicionar</button></div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Descrição</th><th>Valor Base</th><th>Gestão</th></tr></thead>
                                <tbody id="tabela-precos"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="faturacao" class="section">
                    <div class="dashboard-cards" style="grid-template-columns: 1fr;">
                        <div class="card success" style="flex-direction: row; justify-content: space-between; align-items: center;">
                            <div>
                                <h3>Receita Total do Mês</h3>
                                <div class="value" id="total-faturado-mes" style="color: #10b981;">0.00 €</div>
                            </div>
                            <div><input type="month" id="input-mes" onchange="renderFaturacao()" style="padding: 10px; font-weight: 600;"></div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-header"><h3>Extrato Detalhado</h3></div>
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Cliente</th><th>Serviço Realizado</th><th>Valor Cobrado</th><th>Ações</th></tr></thead>
                                <tbody id="tabela-faturacao"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="config" class="section">
                    <div class="panel">
                        <div class="panel-header"><h3>Parâmetros do Sistema</h3></div>
                        <div class="form-grid">
                            <div class="form-group"><label>Horas de Trabalho Diário</label><input type="number" id="config-horas-dia"></div>
                            <div class="form-group"><label>Dias de Trabalho por Semana</label><input type="number" id="config-dias-semana"></div>
                            <div class="form-group"><button class="btn-primary" onclick="salvarConfig()" style="height: 40px;"><i class="fa-solid fa-save"></i> Guardar Alterações</button></div>
                        </div>
                    </div>
                    <div class="panel" style="border-color: #fca5a5; background: #fef2f2;">
                        <div class="panel-header"><h3 style="color: #ef4444;">Zona de Segurança</h3></div>
                        <p style="color: #7f1d1d; margin-bottom: 1rem; font-size: 0.9rem;">Ao encerrar a sessão, será necessário introduzir novamente a palavra-passe para aceder aos dados.</p>
                        <button class="btn-danger" onclick="fazerLogout()"><i class="fa-solid fa-lock"></i> Encerrar Sessão Seguramente</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://bxqlqexumitvhzbuuhpj.supabase.co";
        const SUPABASE_KEY = "sb_publishable_3fQhn8sBTNDXEjpk3SAPXQ_UddrAIH6";
        const supabaseDB = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let clientes = [], faturacaoDB = [], agendaDB = [], servicosDB = [], idEmEdicao = null, idServicoEdicao = null;
        let config = { id: 1, horas_dia: 8, dias_semana: 5 };

        // Colocar a data atual no topo
        const opcoesData = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('data-hoje').innerText = new Date().toLocaleDateString('pt-PT', opcoesData);

        window.onload = async function() {
            const { data: { session } } = await supabaseDB.auth.getSession();
            if (session) entrarNoApp();
        };

        async function verificarLogin() {
            const email = document.getElementById('input-email').value;
            const password = document.getElementById('input-password').value;
            mostrarLoading(true);
            const { error } = await supabaseDB.auth.signInWithPassword({ email, password });
            if (error) { mostrarLoading(false); alert("Credenciais incorretas!"); } else { entrarNoApp(); }
        }

        function entrarNoApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-interface').style.display = 'flex';
            sincronizarComServidor();
        }

        async function fazerLogout() { await supabaseDB.auth.signOut(); window.location.reload(); }
        function mostrarLoading(m) { document.getElementById('loading-screen').style.display = m ? 'flex' : 'none'; }

        async function sincronizarComServidor() {
            mostrarLoading(true);
            const [resC, resF, resA, resConf, resS] = await Promise.all([
                supabaseDB.from('clientes').select('*').order('nome'),
                supabaseDB.from('faturacao').select('*'),
                supabaseDB.from('agenda').select('*'),
                supabaseDB.from('config').select('*').eq('id', 1).single(),
                supabaseDB.from('servicos').select('*').order('nome')
            ]);
            clientes = resC.data || []; faturacaoDB = resF.data || []; agendaDB = resA.data || [];
            servicosDB = resS.data || [];
            if(resConf.data) config = resConf.data;
            renderTudo();
            mostrarLoading(false);
        }

        function renderTudo() {
            const tbodyC = document.getElementById('tabela-clientes');
            tbodyC.innerHTML = ''; let horasMes = 0;
            const selA = document.getElementById('select-cliente-agenda');
            const selS = document.getElementById('select-servico-agenda');
            selA.innerHTML = '<option value="">Selecionar Cliente...</option>';
            selS.innerHTML = '<option value="">Selecionar Serviço...</option>';

            clientes.forEach(c => {
                horasMes += (4 / c.frequencia) * c.duracao;
                selA.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                tbodyC.innerHTML += `<tr>
                    <td><b>${c.nome}</b></td>
                    <td>${c.telefone || '-'}</td>
                    <td><span class="badge">${c.frequencia} Semanas</span></td>
                    <td>${c.duracao}h</td>
                    <td>
                        <button class="btn-primary btn-icon" onclick="carregarParaEdicao('${c.id}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-danger btn-icon" onclick="apagarCliente('${c.id}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            });

            servicosDB.forEach(s => { selS.innerHTML += `<option value="${s.nome}" data-preco="${s.preco}">${s.nome} (${s.preco}€)</option>`; });

            renderPrecos();
            const totalHoras = config.horas_dia * config.dias_semana * 4;
            document.getElementById('dash-total-clientes').innerText = clientes.length;
            document.getElementById('dash-horas-ocupadas').innerText = horasMes.toFixed(1) + 'h';
            document.getElementById('dash-vagas').innerText = Math.max(0, totalHoras - horasMes).toFixed(1) + 'h';
            const perc = Math.min(100, (horasMes / totalHoras) * 100);
            document.getElementById('barra-ocupacao').style.width = perc + '%';
            document.getElementById('texto-ocupacao').innerText = perc.toFixed(1) + '% utilizado';
            renderAgenda(); renderFaturacao();
        }

        function renderPrecos() {
            const tbody = document.getElementById('tabela-precos');
            tbody.innerHTML = '';
            servicosDB.forEach(s => {
                tbody.innerHTML += `<tr>
                    <td><b>${s.nome}</b></td>
                    <td>${s.preco.toFixed(2)} €</td>
                    <td>
                        <button class="btn-primary btn-icon" onclick="carregarServicoEdicao('${s.id}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-danger btn-icon" onclick="apagarServico('${s.id}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        async function salvarServico() {
            const n = document.getElementById('novo-servico-nome').value, p = parseFloat(document.getElementById('novo-servico-preco').value);
            if(!n || isNaN(p)) return;
            mostrarLoading(true);
            if(idServicoEdicao) await supabaseDB.from('servicos').update({nome:n, preco:p}).eq('id', idServicoEdicao);
            else await supabaseDB.from('servicos').insert([{nome:n, preco:p}]);
            idServicoEdicao = null;
            document.getElementById('novo-servico-nome').value = ''; document.getElementById('novo-servico-preco').value = '';
            sincronizarComServidor();
        }

        function carregarServicoEdicao(id) {
            const s = servicosDB.find(x => x.id == id);
            document.getElementById('novo-servico-nome').value = s.nome; document.getElementById('novo-servico-preco').value = s.preco;
            idServicoEdicao = id;
        }

        async function apagarServico(id) { if(confirm("Remover serviço?")) { await supabaseDB.from('servicos').delete().eq('id', id); sincronizarComServidor(); } }

        function renderAgenda() {
            const dia = document.getElementById('input-data-agenda').value;
            const tbody = document.getElementById('tabela-agenda');
            tbody.innerHTML = '';
            const dataFormatada = dia.split('-').reverse().slice(0,2).join('/');
            agendaDB.filter(a => a.dia === dia).sort((x,y) => x.hora.localeCompare(y.hora)).forEach(m => {
                const numLimpo = m.telefone_snapshot ? m.telefone_snapshot.replace(/\s/g, '') : '';
                const textoChat = `Alô ${m.nome_snapshot}, envio mensagem para recordar a marcação de dia ${dataFormatada} às ${m.hora}. Agradeço confirmação. Beijinho! ✨`;
                const linkWpp = numLimpo ? `<a href="https://wa.me/351${numLimpo}?text=${encodeURIComponent(textoChat)}" target="_blank" class="btn-whatsapp" style="text-decoration:none;"><i class="fa-brands fa-whatsapp"></i> Avisar</a>` : '';
                tbody.innerHTML += `<tr>
                    <td><b>${m.hora}</b></td>
                    <td>${m.nome_snapshot}</td>
                    <td><span class="badge">${m.servico}</span></td>
                    <td>${m.telefone_snapshot || '-'}</td>
                    <td>${linkWpp} <button class="btn-danger btn-icon" onclick="apagarAgenda('${m.id}')" style="margin-left:5px"><i class="fa-solid fa-trash"></i></button></td>
                </tr>`;
            });
        }

        function renderFaturacao() {
            const mes = document.getElementById('input-mes').value;
            const tbody = document.getElementById('tabela-faturacao');
            tbody.innerHTML = ''; let total = 0;
            faturacaoDB.filter(f => f.mes === mes).forEach(r => {
                total += r.preco;
                tbody.innerHTML += `<tr>
                    <td><b>${r.nome_snapshot}</b></td>
                    <td>${r.servico_snapshot || '-'}</td>
                    <td><span class="badge badge-green">${r.preco.toFixed(2)} €</span></td>
                    <td><button class="btn-danger btn-icon" onclick="apagarFaturacao('${r.id}')"><i class="fa-solid fa-trash"></i></button></td>
                </tr>`;
            });
            document.getElementById('total-faturado-mes').innerText = total.toFixed(2) + ' €';
        }

        async function addAgenda() {
            const d = document.getElementById('input-data-agenda').value, h = document.getElementById('input-hora-agenda').value;
            const selS = document.getElementById('select-servico-agenda');
            const sNome = selS.value, sPreco = parseFloat(selS.options[selS.selectedIndex]?.getAttribute('data-preco'));
            const idC = document.getElementById('select-cliente-agenda').value;

            if(!d || !h || !idC || !sNome) { alert("Preencha os campos obrigatórios."); return; }
            mostrarLoading(true);
            const c = clientes.find(x => x.id === idC), mesAtual = d.substring(0, 7);
            await supabaseDB.from('agenda').insert([{ dia:d, hora:h, servico:sNome, id_cliente:idC, nome_snapshot:c.nome, telefone_snapshot:c.telefone }]);
            await supabaseDB.from('faturacao').insert([{ mes: mesAtual, preco: sPreco, id_cliente: idC, nome_snapshot: c.nome, servico_snapshot: sNome }]);
            sincronizarComServidor();
        }

        async function salvarCliente() {
            const n = document.getElementById('nome').value, t = document.getElementById('telefone').value;
            const f = parseInt(document.getElementById('frequencia').value), d = parseFloat(document.getElementById('duracao').value);
            if(!n || isNaN(d)) return;
            mostrarLoading(true);
            if(idEmEdicao) await supabaseDB.from('clientes').update({nome:n, telefone:t, frequencia:f, duracao:d}).eq('id', idEmEdicao);
            else await supabaseDB.from('clientes').insert([{nome:n, telefone:t, frequencia:f, duracao:d}]);
            cancelarEdicao(); sincronizarComServidor();
        }

        async function apagarCliente(id) { if(confirm("Apagar cliente do sistema?")) { mostrarLoading(true); await supabaseDB.from('clientes').delete().eq('id', id); sincronizarComServidor(); } }
        function carregarParaEdicao(id) { 
            const c = clientes.find(x => x.id === id); 
            document.getElementById('nome').value = c.nome; document.getElementById('telefone').value = c.telefone;
            document.getElementById('frequencia').value = c.frequencia; document.getElementById('duracao').value = c.duracao;
            idEmEdicao = id; document.getElementById('btn-cancelar-edicao').style.display = 'inline-flex';
            document.getElementById('btn-salvar-cliente').innerHTML = '<i class="fa-solid fa-save"></i> Atualizar';
        }
        function cancelarEdicao() { idEmEdicao = null; document.getElementById('nome').value = ''; document.getElementById('telefone').value = ''; document.getElementById('btn-cancelar-edicao').style.display = 'none'; document.getElementById('btn-salvar-cliente').innerHTML = '<i class="fa-solid fa-save"></i> Registar'; }
        async function apagarAgenda(id) { await supabaseDB.from('agenda').delete().eq('id', id); sincronizarComServidor(); }
        async function apagarFaturacao(id) { await supabaseDB.from('faturacao').delete().eq('id', id); sincronizarComServidor(); }
        async function salvarConfig() {
            const h = document.getElementById('config-horas-dia').value, d = document.getElementById('config-dias-semana').value;
            await supabaseDB.from('config').update({horas_dia:h, dias_semana:d}).eq('id', 1);
            sincronizarComServidor();
        }
        function mudarAba(id, titulo, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(id).classList.add('active'); el.classList.add('active');
            document.getElementById('page-title').innerText = titulo;
        }

        const hoje = new Date();
        document.getElementById('input-mes').value = hoje.getFullYear() + "-" + String(hoje.getMonth() + 1).padStart(2, '0');
        document.getElementById('input-data-agenda').value = hoje.toISOString().split('T')[0];
    </script>
</body>
</html>
