<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mariana Pereira | Gestão Premium</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #09090b; /* Zinc 950 */
            --sidebar-hover: #18181b;
            --bg-app: #f4f4f5; /* Zinc 100 */
            --bg-panel: #ffffff;
            --text-main: #27272a; /* Zinc 800 */
            --text-muted: #71717a; /* Zinc 500 */
            --border-light: #e4e4e7; /* Zinc 200 */
            --accent: #C5A028; /* Soft Gold */
            --accent-light: #fefce8;
            
            --sidebar-width: 250px;
            --topbar-height: 64px;
            --radius-lg: 16px;
            --radius-md: 10px;
            --radius-sm: 6px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-float: 0 10px 40px -10px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        
        body { background-color: var(--bg-app); color: var(--text-main); display: flex; width: 100vw; height: 100vh; overflow: hidden; }

        /* --- LOGIN PREMIUM --- */
        #login-screen {
            position: fixed; inset: 0; background: var(--bg-app);
            display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .login-box { 
            background: var(--bg-panel); padding: 3rem; border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-float); text-align: center; width: 100%; max-width: 400px;
            border: 1px solid var(--border-light);
        }
        .login-box h2 { font-size: 1.5rem; font-weight: 600; color: var(--sidebar-bg); margin-bottom: 0.5rem; letter-spacing: -0.5px;}
        .login-box p { color: var(--text-muted); margin-bottom: 2rem; font-size: 0.9rem; }
        .login-box input { 
            width: 100%; padding: 12px 16px; margin-bottom: 1rem; border: 1px solid var(--border-light); 
            border-radius: var(--radius-md); font-size: 0.95rem; outline: none; transition: var(--transition);
        }
        .login-box input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(197, 160, 40, 0.1); }
        .login-box button { 
            width: 100%; padding: 12px; background: var(--sidebar-bg); color: white; border: none; 
            border-radius: var(--radius-md); font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: var(--transition);
            margin-top: 0.5rem;
        }
        .login-box button:hover { background: #27272a; transform: translateY(-1px); }

        /* --- LOADING --- */
        #loading-screen {
            position: fixed; inset: 0; background: rgba(255,255,255,0.7); backdrop-filter: blur(8px);
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9998;
        }
        .spinner { border: 2px solid var(--border-light); border-top: 2px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- APP SHELL --- */
        #app-interface { display: none; width: 100vw; height: 100vh; }
        
        /* SIDEBAR */
        .sidebar { 
            width: var(--sidebar-width); background: var(--sidebar-bg); color: #a1a1aa; 
            display: flex; flex-direction: column; flex-shrink: 0; height: 100vh;
        }
        .sidebar-header {
            height: var(--topbar-height); display: flex; align-items: center; padding: 0 1.5rem;
            margin-bottom: 2rem; margin-top: 1rem;
        }
        .sidebar-header .logo { font-size: 1.1rem; font-weight: 500; color: white; letter-spacing: 0.5px; display: flex; align-items: center; gap: 10px;}
        .sidebar-header .logo i { color: var(--accent); font-size: 1.2rem;}
        
        .menu-item { 
            padding: 10px 1.5rem; cursor: pointer; transition: var(--transition); 
            font-size: 0.9rem; display: flex; align-items: center; gap: 12px;
            font-weight: 400; margin: 0.2rem 1rem; border-radius: var(--radius-sm);
        }
        .menu-item i { width: 18px; font-size: 1rem; text-align: center; opacity: 0.7;}
        .menu-item:hover { color: white; background: var(--sidebar-hover); }
        .menu-item.active { background: white; color: var(--sidebar-bg); font-weight: 500; box-shadow: var(--shadow-sm);}
        .menu-item.active i { opacity: 1; color: var(--accent); }

        /* MAIN WRAPPER */
        .main-wrapper { flex: 1; display: flex; flex-direction: column; height: 100vh; background: var(--bg-app); position: relative; }

        /* TOPBAR (GLASSMORPHISM) */
        .topbar {
            height: var(--topbar-height); background: rgba(255,255,255,0.8); backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: space-between; 
            padding: 0 2rem; position: absolute; top: 0; left: 0; right: 0; z-index: 10;
        }
        .topbar-title { font-size: 1.1rem; font-weight: 500; color: var(--sidebar-bg); }
        .topbar-date { font-size: 0.85rem; color: var(--text-muted); }

        /* CONTENT */
        .content-area { flex: 1; padding: calc(var(--topbar-height) + 2rem) 2rem 2rem 2rem; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS */
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { 
            background: var(--bg-panel); padding: 1.5rem; border-radius: var(--radius-lg); 
            border: 1px solid var(--border-light); box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column; gap: 0.5rem;
        }
        .card h3 { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; display: flex; align-items: center; gap: 8px;}
        .card .value { font-size: 2rem; font-weight: 500; color: var(--sidebar-bg); letter-spacing: -1px;}

        .panel { 
            background: var(--bg-panel); padding: 2rem; border-radius: var(--radius-lg); 
            border: 1px solid var(--border-light); margin-bottom: 2rem; box-shadow: var(--shadow-sm);
        }
        .panel-header { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .panel-header h3 { font-size: 1.05rem; font-weight: 500; color: var(--sidebar-bg); }

        /* FORMS */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; align-items: end;}
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 0.8rem; font-weight: 500; color: var(--text-muted); }
        input, select { 
            padding: 10px 14px; border: 1px solid var(--border-light); border-radius: var(--radius-md); 
            font-size: 0.9rem; outline: none; transition: var(--transition); background: #fff;
            color: var(--text-main); width: 100%; -webkit-appearance: none; appearance: none;
        }
        input:focus, select:focus { border-color: var(--text-muted); box-shadow: 0 0 0 3px rgba(228, 228, 231, 0.5); }
        select { background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }

        /* BUTTONS */
        button { 
            padding: 10px 18px; border: 1px solid transparent; border-radius: var(--radius-md); cursor: pointer; 
            font-weight: 500; font-size: 0.85rem; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--sidebar-bg); color: white; box-shadow: var(--shadow-sm); }
        .btn-primary:hover { background: #27272a; }
        .btn-secondary { background: white; color: var(--text-main); border-color: var(--border-light); box-shadow: var(--shadow-sm); }
        .btn-secondary:hover { background: var(--bg-app); }
        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-danger:hover { background: #fca5a5; color: #991b1b; }
        .btn-icon { padding: 8px; min-width: 32px; height: 32px; border-radius: var(--radius-sm); }

        /* TABELAS ELEGANTES */
        .table-responsive { width: 100%; overflow-x: auto; margin-top: 0.5rem; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; text-align: left; }
        th { 
            color: var(--text-muted); font-weight: 500; font-size: 0.75rem; padding: 12px 16px; 
            border-bottom: 1px solid var(--border-light); letter-spacing: 0.05em; text-transform: uppercase;
        }
        td { padding: 14px 16px; border-bottom: 1px solid #f4f4f5; font-size: 0.9rem; color: var(--text-main); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #fafafa; }
        
        .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; background: var(--bg-app); color: var(--text-muted); }
        .badge-accent { background: var(--accent-light); color: #856a19; border: 1px solid rgba(197, 160, 40, 0.2); }

        @media (max-width: 1024px) {
            #app-interface { flex-direction: column; }
            .sidebar { width: 100%; height: auto; flex-direction: row; padding: 0.5rem; border-bottom: 1px solid var(--border-light); overflow-x: auto; background: white;}
            .sidebar-header { display: none; }
            .menu-item { padding: 10px; margin: 0; border-radius: var(--radius-lg); flex: 1; justify-content: center; color: var(--text-muted); flex-direction: column; gap: 4px; font-size: 0.75rem;}
            .menu-item.active { background: var(--bg-app); color: var(--sidebar-bg); box-shadow: none;}
            .topbar { position: relative; border-bottom: none; background: transparent; backdrop-filter: none; padding: 1.5rem 1.5rem 0 1.5rem;}
            .content-area { padding: 1.5rem; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="display: flex; justify-content: center; align-items: center; gap: 8px;">
                <i class="fa-solid fa-sparkles" style="color: var(--accent); font-size: 1.2rem;"></i> Mariana Pereira
            </h2>
            <p>Acesso restrito à gestão financeira e agenda.</p>
            <input type="email" id="input-email" placeholder="Endereço de e-mail">
            <input type="password" id="input-password" placeholder="Palavra-passe">
            <button onclick="verificarLogin()">Iniciar Sessão</button>
        </div>
    </div>

    <div id="loading-screen">
        <div class="spinner"></div>
    </div>

    <div id="app-interface">
        
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo"><i class="fa-solid fa-sparkles"></i> Mariana Pereira</div>
            </div>
            <div class="menu-item active" onclick="mudarAba('dashboard', 'Visão Geral', this)"><i class="fa-solid fa-layer-group"></i> Visão Geral</div>
            <div class="menu-item" onclick="mudarAba('agenda', 'Agenda de Serviços', this)"><i class="fa-regular fa-calendar"></i> Agenda</div>
            <div class="menu-item" onclick="mudarAba('clientes', 'Diretório de Clientes', this)"><i class="fa-regular fa-user"></i> Clientes</div>
            <div class="menu-item" onclick="mudarAba('precos-tab', 'Tabela de Preços', this)"><i class="fa-solid fa-list-ul"></i> Serviços</div>
            <div class="menu-item" onclick="mudarAba('faturacao', 'Controlo Financeiro', this)"><i class="fa-solid fa-chart-line"></i> Finanças</div>
            <div class="menu-item" onclick="mudarAba('config', 'Definições', this)"><i class="fa-solid fa-sliders"></i> Definições</div>
        </nav>

        <div class="main-wrapper">
            <header class="topbar">
                <div class="topbar-title" id="page-title">Visão Geral</div>
                <div class="topbar-date" id="data-hoje"></div>
            </header>

            <main class="content-area">
                
                <div id="dashboard" class="section active">
                    <div class="dashboard-cards">
                        <div class="card">
                            <h3><i class="fa-regular fa-address-book"></i> Clientes Registadas</h3>
                            <div class="value" id="dash-total-clientes">0</div>
                        </div>
                        <div class="card">
                            <h3><i class="fa-regular fa-clock"></i> Ocupação Estimada</h3>
                            <div class="value" id="dash-horas-ocupadas">0h</div>
                        </div>
                        <div class="card" style="border-bottom: 2px solid var(--accent);">
                            <h3><i class="fa-solid fa-arrow-trend-up"></i> Capacidade Livre</h3>
                            <div class="value" style="color: var(--accent);" id="dash-vagas">0h</div>
                        </div>
                    </div>
                    <div class="panel" style="padding: 2.5rem;">
                        <div class="panel-header" style="margin-bottom: 1rem;">
                            <h3>Utilização de Capacidade</h3>
                            <span id="texto-ocupacao" style="font-size: 0.85rem; color: var(--text-muted);">0%</span>
                        </div>
                        <div style="height:6px; background:var(--border-light); border-radius:3px; overflow:hidden;">
                            <div id="barra-ocupacao" style="width: 0%; height:100%; background:var(--sidebar-bg); transition: width 1s ease;"></div>
                        </div>
                    </div>
                </div>

                <div id="agenda" class="section">
                    <div class="panel">
                        <div class="panel-header">
                            <h3>Nova Marcação</h3>
                            <input type="date" id="input-data-agenda" onchange="renderAgenda()" style="width: auto; padding: 8px 12px;">
                        </div>
                        <div class="form-grid">
                            <div class="form-group"><label>Selecionar Cliente</label><select id="select-cliente-agenda"></select></div>
                            <div class="form-group"><label>Serviço (Preço Automático)</label><select id="select-servico-agenda"></select></div>
                            <div class="form-group"><label>Hora de Início</label><input type="time" id="input-hora-agenda"></div>
                            <div class="form-group"><button class="btn-primary" onclick="addAgenda()" style="height: 42px;">Agendar & Faturar</button></div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Horário</th><th>Cliente</th><th>Serviço</th><th>Contacto</th><th style="text-align:right;">Gestão</th></tr></thead>
                                <tbody id="tabela-agenda"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="clientes" class="section">
                    <div class="panel">
                        <div class="panel-header"><h3>Detalhes do Cliente</h3></div>
                        <div class="form-grid">
                            <div class="form-group"><label>Nome Completo</label><input type="text" id="nome"></div>
                            <div class="form-group"><label>Nº Telemóvel</label><input type="text" id="telefone"></div>
                            <div class="form-group"><label>Frequência (Semanas)</label><select id="frequencia"><option value="3">3 Semanas</option><option value="4" selected>4 Semanas</option><option value="5">5 Semanas</option></select></div>
                            <div class="form-group"><label>Duração Média</label><select id="duracao"><option value="1">1 Hora</option><option value="1.5">1h 30m</option><option value="2">2 Horas</option></select></div>
                            <div class="form-group" style="flex-direction: row; gap: 10px;">
                                <button id="btn-salvar-cliente" class="btn-primary" style="flex:1" onclick="salvarCliente()">Guardar Ficha</button>
                                <button id="btn-cancelar-edicao" class="btn-secondary" onclick="cancelarEdicao()" style="display:none;"><i class="fa-solid fa-times"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Nome</th><th>Telemóvel</th><th>Manutenção</th><th>Tempo</th><th style="text-align:right;">Ações</th></tr></thead>
                                <tbody id="tabela-clientes"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="precos-tab" class="section">
                    <div class="panel">
                        <div class="panel-header"><h3>Adicionar Serviço à Tabela</h3></div>
                        <div class="form-grid" style="grid-template-columns: 2fr 1fr auto;">
                            <div class="form-group"><label>Descrição do Serviço</label><input type="text" id="novo-servico-nome"></div>
                            <div class="form-group"><label>Valor (€)</label><input type="number" id="novo-servico-preco" step="0.5"></div>
                            <div class="form-group"><button class="btn-primary" onclick="salvarServico()" style="height: 42px;">Adicionar</button></div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Serviço</th><th>Preço de Tabela</th><th style="text-align:right;">Ações</th></tr></thead>
                                <tbody id="tabela-precos"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="faturacao" class="section">
                    <div class="dashboard-cards" style="grid-template-columns: 1fr;">
                        <div class="card" style="flex-direction: row; justify-content: space-between; align-items: center; background: var(--sidebar-bg); border:none;">
                            <div>
                                <h3 style="color: #a1a1aa;">Receita Bruta do Mês</h3>
                                <div class="value" id="total-faturado-mes" style="color: white; font-weight: 400;">0.00 €</div>
                            </div>
                            <div><input type="month" id="input-mes" onchange="renderFaturacao()" style="background: rgba(255,255,255,0.1); border:none; color:white; padding: 10px 15px; font-weight: 500;"></div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="table-responsive">
                            <table>
                                <thead><tr><th>Cliente</th><th>Serviço</th><th>Valor</th><th style="text-align:right;">Ações</th></tr></thead>
                                <tbody id="tabela-faturacao"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="config" class="section">
                    <div class="panel">
                        <div class="panel-header"><h3>Configuração de Horários</h3></div>
                        <div class="form-grid">
                            <div class="form-group"><label>Horas Diárias</label><input type="number" id="config-horas-dia"></div>
                            <div class="form-group"><label>Dias Úteis por Semana</label><input type="number" id="config-dias-semana"></div>
                            <div class="form-group"><button class="btn-secondary" onclick="salvarConfig()" style="height: 42px;">Aplicar Configuração</button></div>
                        </div>
                    </div>
                    <div style="text-align: right; margin-top: 2rem;">
                        <button class="btn-secondary" onclick="fazerLogout()" style="color: #dc2626;"><i class="fa-solid fa-power-off"></i> Terminar Sessão</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://bxqlqexumitvhzbuuhpj.supabase.co";
        const SUPABASE_KEY = "sb_publishable_3fQhn8sBTNDXEjpk3SAPXQ_UddrAIH6";
        const supabaseDB = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let clientes = [], faturacaoDB = [], agendaDB = [], servicosDB = [], idEmEdicao = null, idServicoEdicao = null;
        let config = { id: 1, horas_dia: 8, dias_semana: 5 };

        // Data atual elegante
        const opcoesData = { weekday: 'long', day: 'numeric', month: 'long' };
        document.getElementById('data-hoje').innerText = new Date().toLocaleDateString('pt-PT', opcoesData).replace(/^\w/, c => c.toUpperCase());

        window.onload = async function() {
            const { data: { session } } = await supabaseDB.auth.getSession();
            if (session) entrarNoApp();
        };

        async function verificarLogin() {
            const email = document.getElementById('input-email').value;
            const password = document.getElementById('input-password').value;
            mostrarLoading(true);
            const { error } = await supabaseDB.auth.signInWithPassword({ email, password });
            if (error) { mostrarLoading(false); alert("Credenciais inválidas."); } else { entrarNoApp(); }
        }

        function entrarNoApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-interface').style.display = 'flex';
            sincronizarComServidor();
        }

        async function fazerLogout() { await supabaseDB.auth.signOut(); window.location.reload(); }
        function mostrarLoading(m) { document.getElementById('loading-screen').style.display = m ? 'flex' : 'none'; }

        async function sincronizarComServidor() {
            mostrarLoading(true);
            const [resC, resF, resA, resConf, resS] = await Promise.all([
                supabaseDB.from('clientes').select('*').order('nome'),
                supabaseDB.from('faturacao').select('*'),
                supabaseDB.from('agenda').select('*'),
                supabaseDB.from('config').select('*').eq('id', 1).single(),
                supabaseDB.from('servicos').select('*').order('nome')
            ]);
            clientes = resC.data || []; faturacaoDB = resF.data || []; agendaDB = resA.data || [];
            servicosDB = resS.data || [];
            if(resConf.data) config = resConf.data;
            renderTudo();
            mostrarLoading(false);
        }

        function renderTudo() {
            const tbodyC = document.getElementById('tabela-clientes');
            tbodyC.innerHTML = ''; let horasMes = 0;
            const selA = document.getElementById('select-cliente-agenda'), selS = document.getElementById('select-servico-agenda');
            selA.innerHTML = '<option value="">Selecionar Cliente...</option>'; selS.innerHTML = '<option value="">Selecionar Serviço...</option>';

            clientes.forEach(c => {
                horasMes += (4 / c.frequencia) * c.duracao;
                selA.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                tbodyC.innerHTML += `<tr>
                    <td style="font-weight: 500;">${c.nome}</td>
                    <td>${c.telefone || '-'}</td>
                    <td><span class="badge">${c.frequencia} Sem.</span></td>
                    <td>${c.duracao}h</td>
                    <td style="text-align:right;">
                        <button class="btn-secondary btn-icon" onclick="carregarParaEdicao('${c.id}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-secondary btn-icon" style="color:#ef4444; border:none;" onclick="apagarCliente('${c.id}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            });

            servicosDB.forEach(s => { selS.innerHTML += `<option value="${s.nome}" data-preco="${s.preco}">${s.nome} (${s.preco}€)</option>`; });

            renderPrecos();
            const totalHoras = config.horas_dia * config.dias_semana * 4;
            document.getElementById('dash-total-clientes').innerText = clientes.length;
            document.getElementById('dash-horas-ocupadas').innerText = horasMes.toFixed(1) + 'h';
            document.getElementById('dash-vagas').innerText = Math.max(0, totalHoras - horasMes).toFixed(1) + 'h';
            const perc = Math.min(100, (horasMes / totalHoras) * 100);
            document.getElementById('barra-ocupacao').style.width = perc + '%';
            document.getElementById('texto-ocupacao').innerText = perc.toFixed(1) + '% Ocupado';
            renderAgenda(); renderFaturacao();
        }

        function renderPrecos() {
            const tbody = document.getElementById('tabela-precos');
            tbody.innerHTML = '';
            servicosDB.forEach(s => {
                tbody.innerHTML += `<tr>
                    <td style="font-weight:500;">${s.nome}</td>
                    <td>${s.preco.toFixed(2)} €</td>
                    <td style="text-align:right;">
                        <button class="btn-secondary btn-icon" onclick="carregarServicoEdicao('${s.id}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-secondary btn-icon" style="color:#ef4444; border:none;" onclick="apagarServico('${s.id}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        async function salvarServico() {
            const n = document.getElementById('novo-servico-nome').value, p = parseFloat(document.getElementById('novo-servico-preco').value);
            if(!n || isNaN(p)) return;
            mostrarLoading(true);
            if(idServicoEdicao) await supabaseDB.from('servicos').update({nome:n, preco:p}).eq('id', idServicoEdicao);
            else await supabaseDB.from('servicos').insert([{nome:n, preco:p}]);
            idServicoEdicao = null; document.getElementById('novo-servico-nome').value = ''; document.getElementById('novo-servico-preco').value = '';
            sincronizarComServidor();
        }

        function carregarServicoEdicao(id) {
            const s = servicosDB.find(x => x.id == id);
            document.getElementById('novo-servico-nome').value = s.nome; document.getElementById('novo-servico-preco').value = s.preco;
            idServicoEdicao = id;
        }

        async function apagarServico(id) { if(confirm("Remover serviço?")) { await supabaseDB.from('servicos').delete().eq('id', id); sincronizarComServidor(); } }

        function renderAgenda() {
            const dia = document.getElementById('input-data-agenda').value, tbody = document.getElementById('tabela-agenda');
            tbody.innerHTML = ''; const dataFormatada = dia.split('-').reverse().slice(0,2).join('/');
            agendaDB.filter(a => a.dia === dia).sort((x,y) => x.hora.localeCompare(y.hora)).forEach(m => {
                const numLimpo = m.telefone_snapshot ? m.telefone_snapshot.replace(/\s/g, '') : '';
                const textoChat = `Alô ${m.nome_snapshot}, envio mensagem para recordar a marcação de dia ${dataFormatada} às ${m.hora}. Agradeço confirmação. Beijinho! ✨`;
                const linkWpp = numLimpo ? `<a href="https://wa.me/351${numLimpo}?text=${encodeURIComponent(textoChat)}" target="_blank" style="color:var(--text-muted); text-decoration:none; font-size:0.85rem;"><i class="fa-brands fa-whatsapp"></i> Relembrar</a>` : '';
                tbody.innerHTML += `<tr>
                    <td style="font-weight:500;">${m.hora}</td>
                    <td>${m.nome_snapshot}</td>
                    <td><span class="badge badge-accent">${m.servico}</span></td>
                    <td>${m.telefone_snapshot || '-'}</td>
                    <td style="text-align:right; display:flex; gap:10px; justify-content:flex-end; align-items:center;">
                        ${linkWpp} 
                        <button class="btn-secondary btn-icon" style="color:#ef4444; border:none;" onclick="apagarAgenda('${m.id}')"><i class="fa-solid fa-xmark"></i></button>
                    </td>
                </tr>`;
            });
        }

        function renderFaturacao() {
            const mes = document.getElementById('input-mes').value, tbody = document.getElementById('tabela-faturacao');
            tbody.innerHTML = ''; let total = 0;
            faturacaoDB.filter(f => f.mes === mes).forEach(r => {
                total += r.preco;
                tbody.innerHTML += `<tr>
                    <td style="font-weight:500;">${r.nome_snapshot}</td>
                    <td style="color:var(--text-muted);">${r.servico_snapshot || '-'}</td>
                    <td>${r.preco.toFixed(2)} €</td>
                    <td style="text-align:right;"><button class="btn-secondary btn-icon" style="color:#ef4444; border:none;" onclick="apagarFaturacao('${r.id}')"><i class="fa-solid fa-xmark"></i></button></td>
                </tr>`;
            });
            document.getElementById('total-faturado-mes').innerText = total.toFixed(2) + ' €';
        }

        async function addAgenda() {
            const d = document.getElementById('input-data-agenda').value, h = document.getElementById('input-hora-agenda').value;
            const selS = document.getElementById('select-servico-agenda');
            const sNome = selS.value, sPreco = parseFloat(selS.options[selS.selectedIndex]?.getAttribute('data-preco'));
            const idC = document.getElementById('select-cliente-agenda').value;

            if(!d || !h || !idC || !sNome) return;
            mostrarLoading(true);
            const c = clientes.find(x => x.id === idC), mesAtual = d.substring(0, 7);
            await supabaseDB.from('agenda').insert([{ dia:d, hora:h, servico:sNome, id_cliente:idC, nome_snapshot:c.nome, telefone_snapshot:c.telefone }]);
            await supabaseDB.from('faturacao').insert([{ mes: mesAtual, preco: sPreco, id_cliente: idC, nome_snapshot: c.nome, servico_snapshot: sNome }]);
            sincronizarComServidor();
        }

        async function salvarCliente() {
            const n = document.getElementById('nome').value, t = document.getElementById('telefone').value;
            const f = parseInt(document.getElementById('frequencia').value), d = parseFloat(document.getElementById('duracao').value);
            if(!n || isNaN(d)) return;
            mostrarLoading(true);
            if(idEmEdicao) await supabaseDB.from('clientes').update({nome:n, telefone:t, frequencia:f, duracao:d}).eq('id', idEmEdicao);
            else await supabaseDB.from('clientes').insert([{nome:n, telefone:t, frequencia:f, duracao:d}]);
            cancelarEdicao(); sincronizarComServidor();
        }

        async function apagarCliente(id) { if(confirm("Apagar registo?")) { mostrarLoading(true); await supabaseDB.from('clientes').delete().eq('id', id); sincronizarComServidor(); } }
        function carregarParaEdicao(id) { 
            const c = clientes.find(x => x.id === id); 
            document.getElementById('nome').value = c.nome; document.getElementById('telefone').value = c.telefone;
            document.getElementById('frequencia').value = c.frequencia; document.getElementById('duracao').value = c.duracao;
            idEmEdicao = id; document.getElementById('btn-cancelar-edicao').style.display = 'inline-flex';
            document.getElementById('btn-salvar-cliente').innerText = 'Atualizar';
        }
        function cancelarEdicao() { idEmEdicao = null; document.getElementById('nome').value = ''; document.getElementById('telefone').value = ''; document.getElementById('btn-cancelar-edicao').style.display = 'none'; document.getElementById('btn-salvar-cliente').innerText = 'Guardar Ficha'; }
        async function apagarAgenda(id) { await supabaseDB.from('agenda').delete().eq('id', id); sincronizarComServidor(); }
        async function apagarFaturacao(id) { await supabaseDB.from('faturacao').delete().eq('id', id); sincronizarComServidor(); }
        async function salvarConfig() {
            const h = document.getElementById('config-horas-dia').value, d = document.getElementById('config-dias-semana').value;
            await supabaseDB.from('config').update({horas_dia:h, dias_semana:d}).eq('id', 1);
            sincronizarComServidor();
        }
        function mudarAba(id, titulo, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(id).classList.add('active'); el.classList.add('active');
            document.getElementById('page-title').innerText = titulo;
        }

        const hoje = new Date();
        document.getElementById('input-mes').value = hoje.getFullYear() + "-" + String(hoje.getMonth() + 1).padStart(2, '0');
        document.getElementById('input-data-agenda').value = hoje.toISOString().split('T')[0];
    </script>
</body>
</html>

